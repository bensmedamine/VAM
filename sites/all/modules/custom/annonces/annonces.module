<?php

/**
 * Implements hook_menu().
 */
function annonces_menu() {
  $items['locations-vacances-maroc'] = array(
    'title' => 'Locations vacances au Maroc',
    'page callback' => 'locations_vacances',
    'access callback' => TRUE,
  );
  $items['deposer-une-annonce'] = array(
    'title' => 'DÃ©poser une annonce',
    'page callback' => 'deposer_annonce',
    'access callback' => TRUE,
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function annonces_theme() {
  return array(
    'listing_annonces' => array(
      'template' => 'themes/listing_annonces'
    ),
    'deposer_annonce' => array(
      'template' => 'themes/deposer_annonce'
    ),
  );
}

function locations_vacances() {
  global $theme_path;

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = 'Locations vacances au Maroc';
  drupal_set_breadcrumb($breadcrumb);

  drupal_add_css($theme_path . '/css/inner.css');

  $query = new EntityFieldQuery();
  $entities = $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'annonce')
      ->propertyCondition('status', 1)
      ->propertyOrderBy('created', 'DESC')
      ->pager(10)
      ->execute();

  $nodes = node_load_multiple(array_keys($entities['node']));

  $output = theme('listing_annonces', array('nodes' => $nodes, 'total' => $query->pager['total']));
  $output .= theme('pager', array('tags' => array()));
  return $output;
}

function deposer_annonce() {

  return theme('deposer_annonce');
}

/**
 * Implementation of hook_query_TAG_alter
 */
function annonces_query_random_alter($query) {
  $query->orderRandom();
}

function get_annonces_par_ville($tid, $nbr) {

  $query = new EntityFieldQuery();
  $entities = $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'annonce')
      ->propertyCondition('status', 1)
      ->fieldCondition('field_ville', 'tid', $tid)
      ->addTag('random')
      ->range(0, $nbr)
      ->execute();

  $nodes = node_load_multiple(array_keys($entities['node']));
  return $nodes;
}

function get_count_annonces_par_ville($tid) {
  $count = db_query('SELECT COUNT(field_ville_tid) total FROM vam_field_data_field_ville WHERE field_ville_tid = :tid', array(':tid' => $tid))
      ->fetch();
  return $count->total;
}

?>
